<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Station Keeping â€“ Mission Control</title>

  <!-- CesiumJS -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
  <link
    href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />

  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #000;
      font-family: sans-serif;
    }
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      background: rgba(0, 0, 0, 0.7);
      padding: 20px;
      border-radius: 10px;
      z-index: 999;
      pointer-events: none;
    }
    #runSelectorContainer {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      z-index: 1000;
      font-size: 13px;
    }
    #runSelectorContainer label {
      margin-right: 6px;
    }
    #runSelect {
      background: #111;
      color: #fff;
      border-radius: 4px;
      border: 1px solid #555;
      padding: 2px 4px;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <div id="loading">Lade Station-Keeping-Mission...</div>

  <div id="runSelectorContainer">
    <label for="runSelect">Run:</label>
    <select id="runSelect">
      <option value="perfect">Robust run (sim_2900)</option>
      <option value="early">Early run (sim_0008)</option>
      <option value="free">Free drift (uncontrolled)</option>
    </select>
  </div>

  <script>
    Cesium.Ion.defaultAccessToken = "";

    const osmImagery = new Cesium.UrlTemplateImageryProvider({
      url: "https://tile.openstreetmap.org/{z}/{x}/{y}.png"
    });

    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrainProvider: new Cesium.EllipsoidTerrainProvider(),
      imageryProvider: osmImagery,
      baseLayerPicker: false,
      geocoder: false,
      homeButton: false,
      sceneModePicker: false,
      navigationHelpButton: false,
      animation: true,
      timeline: true,
      shouldAnimate: true
    });

    viewer.scene.globe = new Cesium.Globe(Cesium.Ellipsoid.WGS84);

    viewer.scene.globe.imageryLayers.removeAll();
    viewer.scene.globe.imageryLayers.addImageryProvider(
      new Cesium.OpenStreetMapImageryProvider({
        url: "https://tile.openstreetmap.org/"
      })
    );

    viewer.scene.globe.enableLighting = true;
    viewer.scene.highDynamicRange = true;

    const czmlFile = "station_keeping_mission.czml";
    console.log("Loading CZML:", czmlFile);

    Cesium.CzmlDataSource.load(czmlFile)
      .then(function (dataSource) {
        viewer.dataSources.add(dataSource);

        const perfectProbe = dataSource.entities.getById("StationKeepingProbe");
        const earlyProbe   = dataSource.entities.getById("StationKeepingProbe_Run0008");
        const freeProbe    = dataSource.entities.getById("StationKeepingProbe_FreeDrift");

        const runSelect = document.getElementById("runSelect");

        function applyRunSelection(value) {
          const entities = dataSource.entities.values;

          for (let i = 0; i < entities.length; i++) {
            const entity = entities[i];

            const isPerfect = entity.id === "StationKeepingProbe";
            const isEarly   = entity.id === "StationKeepingProbe_Run0008";
            const isFree    = entity.id === "StationKeepingProbe_FreeDrift";

            if (!isPerfect && !isEarly && !isFree) {
              continue;
            }

            const shouldShow =
              (value === "perfect" && isPerfect) ||
              (value === "early"   && isEarly) ||
              (value === "free"    && isFree);

            entity.show = shouldShow;
            if (entity.model) {
              entity.model.show = shouldShow;
            }
          }

          if (value === "perfect" && perfectProbe) {
            viewer.trackedEntity = perfectProbe;
          } else if (value === "early" && earlyProbe) {
            viewer.trackedEntity = earlyProbe;
          } else if (value === "free" && freeProbe) {
            viewer.trackedEntity = freeProbe;
          }
        }

        // Initial state: robust run only
        applyRunSelection("perfect");
        if (runSelect) {
          runSelect.value = "perfect";
          runSelect.addEventListener("change", function () {
            applyRunSelection(runSelect.value);
          });
        }

        document.getElementById("loading").style.display = "none";
      })
      .catch(function (error) {
        console.error(error);
        document.getElementById("loading").innerText =
          "Fehler beim Laden der CZML-Datei: " + error;
      });
  </script>
</body>
</html>
